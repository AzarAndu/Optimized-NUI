<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spare Parts Search</title>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
:root{
  --bg:#f5f6fa; --card:#fff; --primary:#007bff; --text:#222;
  --dark-bg:#1f2933; --dark-card:#2d3748; --dark-text:#e5e7eb;
}
body{font-family:Arial;margin:16px;background:var(--bg);color:var(--text);}
body.dark{background:var(--dark-bg);color:var(--dark-text);}
h2{margin:0 0 8px;font-size:28px}
.topbar{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;margin-bottom:10px}
.btn{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#e5e7eb}
#search{width:100%;max-width:420px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px}
table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#e6e9f0}
.compact th,.compact td{padding:6px;font-size:13px}
body.dark table{background:var(--dark-card)}
body.dark th{background:#111827;color:var(--dark-text)}
.pagination{margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.highlight{background:#ffeaa7 !important}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;padding:14px;border-radius:10px;width:94%;max-width:500px}
#qr-reader{width:100%;height:300px}

@media(max-width:600px){
  h2{font-size:22px}
  #qr-reader{height:240px}
}
</style>
</head>

<body>

<h2>Spare Parts Search</h2>

<div class="topbar">
  <button id="btn-scan" class="btn btn-primary">ðŸ“· Scan</button>
  <button id="btn-refresh" class="btn btn-secondary">â†» Refresh</button>
  <button id="btn-export" class="btn btn-secondary">â¬‡ Export CSV</button>
  <label>Dark <input type="checkbox" id="darkToggle"></label>
  <label>Compact <input type="checkbox" id="compactToggle"></label>
</div>

<input id="search" placeholder="Search part / description / category / qty">

<table>
<thead>
<tr>
  <th>#</th><th>Item No</th><th>Part No</th><th>Description</th><th>Category</th><th>Qty</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="pagination">
  <button id="prev" class="btn btn-secondary">Prev</button>
  <span id="pageInfo"></span>
  <button id="next" class="btn btn-secondary">Next</button>
  <input id="jump" type="number" placeholder="Page #" style="width:80px">
  <button id="jumpBtn" class="btn btn-secondary">Go</button>
</div>

<!-- SCANNER -->
<div id="qr-backdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Scan Code</h3>
    <div id="qr-reader"></div>
    <button id="qr-close" class="btn btn-secondary">Close</button>
  </div>
</div>

<script>
const URL="https://sheetdb.io/api/v1/bvdsyfvkla1lv";
const tbody=document.getElementById("tbody");
const search=document.getElementById("search");
const pageInfo=document.getElementById("pageInfo");

let all=[],page=1,perPage=50,scanner,highlightValue=null;

/* ===== FIX TRAILING SPACES ===== */
function cleanKeys(o){
  const r={};
  for(const k in o) r[k.trim()]=o[k];
  return r;
}

/* ===== OFFLINE CACHE ===== */
function saveCache(data){
  localStorage.setItem("spare_cache",JSON.stringify(data));
}
function loadCache(){
  try{
    return JSON.parse(localStorage.getItem("spare_cache")||"[]");
  }catch{ return []; }
}

/* ===== LOAD ===== */
async function load(){
  try{
    const res=await fetch(URL);
    const json=await res.json();
    all=prepare(json);
    saveCache(all);
  }catch{
    all=loadCache();
    alert("Offline mode: loaded cached data");
  }
  page=1;
  render();
}

/* ===== PREPARE ===== */
function prepare(json){
  return json.map(x=>{
    const r=cleanKeys(x);
    r._s=((r["item no"]||"")+" "+(r["part no"]||"")+" "+(r["description"]||"")+" "+(r["category"]||"")+" "+(r["qty"]||"")).toLowerCase();
    return r;
  });
}

/* ===== RENDER ===== */
function render(){
  const q=search.value.toLowerCase();
  const list=q?all.filter(r=>r._s.includes(q)):all;

  const pages=Math.max(1,Math.ceil(list.length/perPage));
  if(page>pages) page=pages;

  const start=(page-1)*perPage;
  const view=list.slice(start,start+perPage);

  tbody.innerHTML=view.map((r,i)=>{
    const val=(r["part no"]||"")+r["item no"];
    return `
    <tr class="${highlightValue && val.includes(highlightValue)?"highlight":""}">
      <td>${start+i+1}</td>
      <td>${r["item no"]||""}</td>
      <td>${r["part no"]||""}</td>
      <td>${r["description"]||""}</td>
      <td>${r["category"]||""}</td>
      <td>${r["qty"]||""}</td>
    </tr>`;
  }).join("");

  pageInfo.textContent=`Page ${page} of ${pages} (${list.length})`;
}

/* ===== EVENTS ===== */
search.oninput=()=>{page=1;render();};
prev.onclick=()=>{if(page>1){page--;render();}};
next.onclick=()=>{page++;render();};
jumpBtn.onclick=()=>{
  const p=parseInt(jump.value);
  if(p>0){page=p;render();}
};

/* ===== EXPORT CSV ===== */
btn-export.onclick=()=>{
  const q=search.value.toLowerCase();
  const list=q?all.filter(r=>r._s.includes(q)):all;

  let csv="Item No,Part No,Description,Category,Qty\n";
  list.forEach(r=>{
    csv+=`"${r["item no"]||""}","${r["part no"]||""}","${r["description"]||""}","${r["category"]||""}","${r["qty"]||""}"\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="spare_parts.csv";
  a.click();
};

/* ===== SCANNER ===== */
const backdrop=document.getElementById("qr-backdrop");
btn-scan.onclick=()=>{
  backdrop.style.display="flex";
  scanner=new Html5Qrcode("qr-reader");
  scanner.start({facingMode:"environment"},{fps:10,qrbox:250},txt=>{
    search.value=txt;
    highlightValue=txt;
    page=1;
    render();
    scanner.stop();
    backdrop.style.display="none";
  });
};
qr-close.onclick=()=>{
  if(scanner) scanner.stop();
  backdrop.style.display="none";
};

/* ===== THEME ===== */
darkToggle.checked=localStorage.dark==="1";
compactToggle.checked=localStorage.compact==="1";
document.body.classList.toggle("dark",darkToggle.checked);
document.body.classList.toggle("compact",compactToggle.checked);

darkToggle.onchange=()=>{
  document.body.classList.toggle("dark",darkToggle.checked);
  localStorage.dark=darkToggle.checked?"1":"";
};
compactToggle.onchange=()=>{
  document.body.classList.toggle("compact",compactToggle.checked);
  localStorage.compact=compactToggle.checked?"1":"";
};

btn-refresh.onclick=load;

load();
</script>

</body>
</html>
